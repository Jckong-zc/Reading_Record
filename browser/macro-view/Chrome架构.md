# Chrome 架构

## Chrome 浏览器是基于多进程架构的实现

在 Chrome 中打开一个 页面会启动四个进程

## 进程和线程

- 并行处理

  计算机中的并行处理就是同一时刻处理多个任务

  单线程情况下：多个任务依次按顺序单独执行

  多线程情况下：多个线程同时执行单独的任务

  **使用并行处理能大大提升性能**

- 进程 & 线程

  **线程是不能单独存在的，它是由进程来启动和管理的**

  **一个进程就是一个程序的运行实例**

  启动一个程序的时候，操作系统会给该程序创建一块内存，用来存放代码、运行中的数据和一个执行任务的主线程

  **线程是依附于进程的，而进程中使用多线程并行处理能提升运算效率**

- 进程和线程的关系

  1. **进程中的任意一线程执行出错，都会导致整个进程的崩溃**

  2. **线程之间共享进程中的数据**

     线程之间可以对进程的公共数据进行读写操作

  3. **当一个进程关闭之后，操作系统会回收进程所占用的内存**

     即使因为操作不当造成内存泄漏，在进程退出的时候内存也会被正确回收

  4. **进程之间的内容相互隔离**

     一个进程崩溃或挂起不会影响其他进程

> **进程** 就是一个公司，每个公司都有自己的资源可以调度；公司之间是相互独立的；而 **线程** 就是公司中的每个员工，多个员工一起合作，完成任务，公司可以有一名员工或多个，员工之间共享公司的空间。

## 单进程浏览器

浏览器的所有功能模块都是运行在同一个进程里

### 单进程浏览器存在的问题

- 不稳定

  插件：早期浏览器的一些强大的功能需要借助插件来实现，插件很容易出问题崩溃导致浏览器的崩溃

  渲染引擎：一些复杂的 JavaScript 代码就有可能引起渲染引擎模块的崩溃，渲染引擎的崩溃也会导致整个浏览器的崩溃

- 不流畅

  同一时刻只能有一个模块可以执行，如果有无限循环脚本，它会独占整个线程导致该线程的其他模块没有机会被执行，造成卡顿

- 不安全

  插件：插件可用  C/C++ 等代码编写，通过插件可以获取到操作系统的任意资源，恶意插件会引发安全性问题

  页面脚本：可以通过浏览器的漏洞来获取系统权限

## 多进程浏览器

最新的 Chrome 浏览器包括：1 个浏览器（Browser）主进程、1 个 GPU 进程、1 个网络（NetWork）进程、多个渲染进程和多个插件进程

- **浏览器进程：**主要负责界面显示、用户交互、子进程管理，同时提供存储等功能
- **渲染进程：**将 HTML、CSS 和 JS 转换成可以让用于交互的页面，渲染进程运行在沙箱模式下，更加安全
- **GPU 进程：**Chrome 最开始没有 GPU 进程，GPU 的使用初衷是为了实现 3D CSS 的效果，只是随后网页、Chrome 的 UI 界面都选择采用 GPU 来绘制，这使得 GPU 成为浏览器普遍的需求
- **网络进程：**负责页面的网络资源加载
- **插件进程：**主要是负责插件的运行，因插件易崩溃，所以需要通过插件进程来**隔离**，以保证插件进程崩溃不会对浏览器和页面造成影响

打开一个页面至少有 1 个网络进程、1 个浏览器进程、1 个 GPU 进程以及 1 个渲染进程，如果打开的页面有运行插件的话，还需要再加上 1 个插件进程

### 多进程模型的问题

- **更高的资源占用：**每个进程都会包含公共基础结构的副本
- **更复杂的体系架构：**浏览器各模块之间耦合性高、扩展性差等问题，会导致现在的架构已经很难适应新的需求

